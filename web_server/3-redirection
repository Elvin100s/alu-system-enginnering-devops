#!/usr/bin/env bash
# This script configures a new Ubuntu machine to set up Nginx and redirect /redirect_me to https://www.youtube.com/watch?v=QH2-TGUlwu4 with a 301 Moved Permanently status.

# Function to install shellcheck if it is not already installed
install_shellcheck() {
    if ! command -v shellcheck &> /dev/null; then
        echo "shellcheck could not be found, installing now..."
        sudo apt-get update
        sudo apt-get install -y shellcheck
    else
        echo "shellcheck is already installed."
    fi
}

# Install shellcheck
install_shellcheck

# Update package list and install nginx
sudo apt-get update
sudo apt-get install -y nginx

# Backup the default Nginx configuration
sudo cp /etc/nginx/sites-available/default /etc/nginx/sites-available/default.backup

# Remove the backup file from sites-enabled if it exists
if [ -f /etc/nginx/sites-enabled/default.backup ]; then
    sudo rm /etc/nginx/sites-enabled/default.backup
fi

# Modify the Nginx configuration to include the redirect
sudo sed -i '/^server {/a \
location = \/redirect_me {\
    return 301 https:\/\/www.youtube.com\/watch?v=QH2-TGUlwu4;\
}' /etc/nginx/sites-available/default

# Ensure the default site is enabled
sudo ln -sf /etc/nginx/sites-available/default /etc/nginx/sites-enabled/default

# Test the Nginx configuration
if sudo nginx -t; then
    # Reload Nginx to apply the changes
    if sudo systemctl is-active --quiet nginx; then
        sudo systemctl reload nginx
    else
        sudo systemctl start nginx
    fi
else
    echo "Nginx configuration test failed. Please check the configuration file."
fi
