#!/usr/bin/env bash
# Script that configures a new Ubuntu machine to redirect /redirect_me to https://www.github.com/Elvin100s.

# Update the package list and install Nginx
sudo apt-get update
sudo apt-get -y install nginx

# Allow Nginx HTTP traffic through the firewall
if command -v ufw &> /dev/null; then
    sudo ufw allow 'Nginx HTTP'
else
    echo "UFW is not installed or not available. Skipping UFW configuration."
fi

# Backup the original Nginx configuration file
sudo cp /etc/nginx/sites-enabled/default /etc/nginx/sites-enabled/default.backup

# Configure Nginx to redirect /redirect_me
sudo sed -i '/^server {/,/^}/ {
    /^server {/a \
    \trewrite ^/redirect_me https://www.github.com/Elvin100s permanent;
}' /etc/nginx/sites-enabled/default

# Test the Nginx configuration
if sudo nginx -t; then
    # Restart Nginx to apply the changes
    sudo service nginx restart
    echo "Nginx configuration updated successfully."
else
    # Restore the backup if the configuration is invalid
    sudo cp /etc/nginx/sites-enabled/default.backup /etc/nginx/sites-enabled/default
    echo "Nginx configuration is invalid. Restored the backup."
fi
